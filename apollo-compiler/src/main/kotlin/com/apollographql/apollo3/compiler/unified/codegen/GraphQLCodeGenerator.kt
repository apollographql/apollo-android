package com.apollographql.apollo3.compiler.unified.codegen

import com.apollographql.apollo3.compiler.VERSION
import com.apollographql.apollo3.compiler.unified.IntermediateRepresentation
import com.squareup.kotlinpoet.FileSpec
import com.squareup.kotlinpoet.KModifier
import com.squareup.kotlinpoet.TypeSpec
import java.io.File

/**
 * KotlinPoet [TypeSpec] are non qualified. This is a simple wrapper that carries a package name so that we can write the file
 */
class QualifiedTypeSpec(
    val packageName: String,
    val typeSpec: TypeSpec,
)

class GraphQLCodeGenerator(
    private val ir: IntermediateRepresentation,
    private val generateAsInternal: Boolean = false,
    private val enumAsSealedClassPatternFilters: List<Regex>,
    private val generateScalarMapping: Boolean,
) {
  fun write(outputDir: File) {
    val customScalars = if (generateScalarMapping) {
      listOf(ir.customScalars.qualifiedTypeSpec())
    } else {
      emptyList()
    }

    val enums = ir.enums.flatMap { enum ->
      enum.qualifiedTypeSpecs(enumAsSealedClassPatternFilters = enumAsSealedClassPatternFilters)
    }

    val inputObjects = ir.inputObjects.flatMap { inputObject ->
      inputObject.qualifiedTypeSpecs()
    }

    val operations = ir.operations.flatMap { operation ->
      operation.qualifiedTypeSpecs()
    }

    val qualifiedTypeSpecs = customScalars + enums + inputObjects + operations

    qualifiedTypeSpecs.groupBy { "${it.packageName}.${it.typeSpec.name}" }
        .forEach {
          check(it.value.size == 1) {
            "Duplicate TypeSpec found: ${it.key}"
          }
        }

    qualifiedTypeSpecs.forEach {
      it.typeSpec
          .fileSpec(it.packageName)
          .writeTo(outputDir)
    }
  }

  /**
   * Generates a file with the name of this type and the specified package name
   */
  private fun TypeSpec.fileSpec(packageName: String) = fileSpecBuilder(packageName, name!!)
      .addType(this.internal(generateAsInternal))
      .build()

  private fun fileSpecBuilder(packageName: String, name: String): FileSpec.Builder =
      FileSpec
          .builder(packageName, name)
          .addComment("\nAUTO-GENERATED FILE. DO NOT MODIFY.\n\n" +
              "This class was automatically generated by Apollo GraphQL version '$VERSION'.\n"
          )

  private fun TypeSpec.internal(generateAsInternal: Boolean): TypeSpec {
    return if (generateAsInternal) {
      this.toBuilder().addModifiers(KModifier.INTERNAL).build()
    } else {
      this
    }
  }
}