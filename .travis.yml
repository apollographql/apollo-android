language: android

jdk:
  - oraclejdk8

android:
  components:
    - tools
    - platform-tools
    - tools  # Upgrade again after upgrading platform-tools
    - build-tools-26.0.2
    - android-22
    - extra-google-m2repository
    - extra-android-m2repository
    - sys-img-armeabi-v7a-android-22
  licenses:
    - android-sdk-preview-license-.+
    - android-sdk-license-.+
    - google-gdk-license-.+

script:
  - ./gradlew clean build connectedCheck -x checkstyleTest --stacktrace --max-workers=2 -x apollo-gradle-plugin:test -x apollo-integration:build -x apollo-integration:connectedCheck
  - .buildscript/integration_tests_composite.sh

before_script:
  - echo no | android create avd --force -n test -t android-22 --abi armeabi-v7a
  - emulator -avd test -no-audio -no-window &
  - android-wait-for-emulator
  - adb shell input keyevent 82

after_success:
  - .buildscript/deploy_snapshot.sh

env:
  global:
    - secure: "eJmRRDJISzMFLpgBIOVMWK1yiDzW75X0Xj9sV7dqiWFHz3YStArMRyPqCSjcbC0xrB4Krl2fJg5hK7Pvod5EXwjYa9eC5eNC41nsiQ7ajHjJ+mmMLU4e1n+M5mS0Koa9FNs47nGYKKmKVBT4Ra6YgjeWKcdyC5hcmU58a8AiC8JlEODBLCe+/czXW9sGk/3joaYdRBBCO9R1jP2yEdKc/BgiC48dsWacNBogXUTeqVI/LTeIw3LeAmk+L8oLJEq4qsG0mPhr2vxJpxLczGzylcS1wZQ0JHfMtUQxLAxs1xTnLR/GqnJCjpHP5ybBtZ7WEZRL/kTRnZAELPP/+eIPLuNqOWmUKZPmbm2dC4bUZMbBOOzMQsxYbuJpWjYa4I0NKXGxDRWrxHaBDZ1fzD5wCzsEuL+kQ43Sz6nq65i4ayID2QUkPakIpGPSFSCTHY0S7L3NtDf0GYKeazAm5+oRnpzgH+McwW5orw6vvvylSW0xBSvIQL6I4HETVE/Larsg+HCPkGxQNjPMIFloQXTRe9DuPr83DKjG3Ik2q6kBoycaCOakut8x3gYLDSVIktOYhMvfm066i7VQ1OXpy6v/QnPAyDUVznqJffEz5SF2AU6hGjHm4TbBmBhUqiw5zafnDoqDfhhbkQqO8iJaV8QkQyYVJtnxvhYk/Q9lXNvhgV0="
    - secure: "L2cS/0fxQgThfiAXugdhCDDtOiVktZaHszRRh1C4biQ+K4pGsBiRBL/ajI3MLZjQzcY/PKRdwaj3Y7eTJqsBF9B616H59Qo4kKL3VjMxaazzngLRDaDEhe4l5lfhEKqErlHYWu6L9Gv6/6Y9QqdSxjM9/NEJNMSIz9+qGxgahD4QMJ3HUyMDNeUkfR8svhD5wVO1jLORe/ajoRk+Ji2m1tfYk/YMqSd4EvRbjQ8NoKjzQgyXhDVtgs/Kkp3U4XVXTFYO1OFH020gSwDUd3UBJC5IUBZoT8oJoJMMiFvM/IHnWsOUDT/zkAtMv9HDvw9jyTrEwojTEb1UEOOPmfDRVVYahOW5Oja/IXbhkEgoiiTERJCuKlLRQfGOMu87M4apgISB0uIfs7NjDIdHxBevAd2mwunqjOFuVoadHafWU9XBLeUCwgBtX6B1WuWqbOHwUHxkbMMQ1LVVSB9mBRsycbWlQ/P17t1DbH0+BDCUJ9+wGkLK+AWeyZbhxoRHGp5711CbPjQH5Y/QEdqxjHnM9bHT4EzgR9D80hE4rJTeVcm3zyStowEUon55r6w+dxQXS0SkTPkVBLp5JLySRKuZyBWoeDykqdeHEVMnaG3zqjW6gRr3rn5pqznqVjmapmc+4UNTU4nrUQUJWb1DStd60p+znFa+hNqDSQ7GbHMdZnE="
    - GRADLE_OPTS="-Xmx2048m"
    - ADB_INSTALL_TIMEOUT=8 # minutes (2 minutes by default)

notifications:
  email: false

branches:
  except:
    - gh-pages

sudo: false

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache
